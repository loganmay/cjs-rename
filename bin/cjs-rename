#!/usr/bin/env node
// vi:syntax=javascript

var program = require('commander');
var Rename = require('../lib/rename');
var package = require('../package.json');
var Path = require('../lib/path');

var RED   = '\u001b[31m';
var BLUE  = '\u001b[34m';
var RESET = '\u001b[0m';

program
  .version(package.version)
  .option('-d, --dry', 'Do not write changes to disk.')
  .option('-s, --search', 'Search by filename')
  .command('*')
  .description('cjs-rename [from] [to] [source...]')
  .action(command);

program.parse(process.argv);

// Show help if no args
if (! program.args.length) {
  console.log(program.help());
}

function command (from, to, source) {

  var rename = new Rename({
    mode: program.search ? 'search' : 'path',
    to: to,
    from: from,
    folder: typeof(source) === 'string' ? source : undefined,
    dryrun: program.dry === true
  });

  rename.run().then(function () {

    if (rename.changes.length + rename.files.length === 0) {
      return console.log('No changes made');
    }

    if (program.dry) {
      console.log(RED + '[drymode]: will not save changes' + RESET);
    }

    var change, path, from, to;

    console.log('\nMoving:');

    rename.files.forEach(function (file) { 
      from = Path.relative(rename.cwd, file.from);
      to   = Path.relative(rename.cwd, file.to);
      console.log('-',  BLUE + from, RESET + '>' + BLUE, to, RESET);
    });

    console.log('\nFixing:');

    rename.changes.forEach(function (change) {
      path = Path.relative(rename.cwd, change.path);
      console.log('- [' + change.count + ']' + BLUE, path, RESET);
    });

  });

}
